<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nanda Teknik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        #map { height: 250px; border-radius: 1rem; margin-bottom: 1rem; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 2rem; border: 1px solid white; }
    </style>
</head>
<body class="p-4 bg-slate-50" onload="checkAutoLogin()">
    <div class="max-w-md mx-auto space-y-4">
        <header class="text-center py-4">
            <h1 class="text-3xl font-black text-blue-600 italic uppercase">NANDA TEKNIK</h1>
            <div id="user-badge" class="hidden text-[10px] font-bold text-slate-500 bg-white inline-block px-3 py-1 rounded-full border shadow-sm mt-2"></div>
        </header>

        <div id="main-card" class="glass p-6 shadow-xl">
            <div id="dynamic-area">
                <div class="text-center py-10 text-slate-400">Loading...</div>
            </div>
            <div id="footer-menu" class="mt-6 pt-4 border-t flex justify-between px-2">
                <button onclick="formHistory()" class="text-[10px] font-black text-slate-400 uppercase">Riwayat</button>
                <button id="btn-logout" onclick="handleLogout()" class="hidden text-[10px] font-black text-red-500 uppercase">Logout</button>
            </div>
        </div>
    </div>

    <div id="map-storage" class="hidden"><div id="map"></div></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwD_TDXWHPfLGNxS5RPrmHm9S3tYp8Jd4QNFDl9H6uBDvwcT2pSq5LNYLuA-XCEhvAQzg/execA"; // GANTI INI
        let map, marker, selectedPos, customerData;

        async function callAPI(action, data = {}) {
            const params = new URLSearchParams({ action, ...data });
            const response = await fetch(`${API_URL}?${params.toString()}`);
            return await response.json();
        }

        function checkAutoLogin() {
            const saved = localStorage.getItem('nanda_teknik_user');
            if (saved) {
                customerData = JSON.parse(saved);
                showBookingForm();
            } else {
                showLandingPage();
            }
        }

        function showLandingPage() {
            document.getElementById('dynamic-area').innerHTML = `
                <div id="map-container"></div>
                <button onclick="getLocation()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl mb-4">üìç Tentukan Lokasi Saya</button>
                <div id="action-buttons" class="hidden grid grid-cols-2 gap-4">
                    <button onclick="formLogin()" class="bg-blue-600 text-white py-4 rounded-xl font-bold">LOGIN</button>
                    <button onclick="formDaftar()" class="bg-slate-800 text-white py-4 rounded-xl font-bold">DAFTAR</button>
                </div>`;
            initMap('map-container');
        }

        function formDaftar() {
            document.getElementById('dynamic-area').innerHTML = `
                <div class="space-y-3">
                    <input id="reg_nama" type="text" placeholder="Nama Lengkap" class="w-full p-4 border rounded-xl">
                    <input id="reg_email" type="email" placeholder="Email Aktif" class="w-full p-4 border rounded-xl">
                    <input id="reg_wa" type="number" placeholder="WhatsApp" class="w-full p-4 border rounded-xl">
                    <input id="reg_tgl" type="date" class="w-full p-4 border rounded-xl">
                    <button onclick="handleRegister()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">DAFTAR SEKARANG</button>
                </div>`;
        }

        async function handleRegister() {
            const d = {
                nama: document.getElementById('reg_nama').value,
                email: document.getElementById('reg_email').value,
                whatsapp: document.getElementById('reg_wa').value,
                tgl_lahir: document.getElementById('reg_tgl').value,
                lat: selectedPos.lat, lng: selectedPos.lng
            };
            Swal.fire({title:'Proses...', didOpen:()=>Swal.showLoading()});
            const res = await callAPI('registerCustomer', d);
            Swal.fire('Berhasil', res, 'success').then(()=>location.reload());
        }

        async function formLogin() {
            const { value: email } = await Swal.fire({ title: 'Login', input: 'email' });
            if (email) {
                const res = await callAPI('checkCustomer', { email });
                if (res.exists) {
                    if (!res.active) return Swal.fire('Belum Aktif', 'Cek email Anda atau tunggu aktivasi admin.', 'warning');
                    customerData = res.data;
                    localStorage.setItem('nanda_teknik_user', JSON.stringify(res.data));
                    location.reload();
                } else {
                    Swal.fire('Error', 'Email tidak terdaftar.', 'error');
                }
            }
        }

        function showBookingForm() {
            document.getElementById('user-badge').innerText = `Halo, ${customerData.nama}`;
            document.getElementById('user-badge').classList.remove('hidden');
            document.getElementById('btn-logout').classList.remove('hidden');
            document.getElementById('dynamic-area').innerHTML = `
                <div class="space-y-4">
                    <input id="bk_tgl" type="date" class="w-full p-4 border rounded-xl">
                    <input id="bk_job" type="text" placeholder="Contoh: Cuci AC" class="w-full p-4 border rounded-xl">
                    <div class="p-4 bg-orange-50 rounded-xl flex justify-between font-bold">
                        <span class="text-orange-600">Ongkos Transport</span>
                        <span id="txt-ongkos">Rp0</span>
                    </div>
                    <button onclick="handleBooking()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">ORDER SEKARANG</button>
                </div>`;
            updateOngkos();
        }

        async function updateOngkos() {
            const ongkos = await callAPI('hitungTransport', { lat: customerData.lat, lng: customerData.lng });
            document.getElementById('txt-ongkos').innerText = ongkos === 0 ? "GRATIS" : `Rp${ongkos.toLocaleString()}`;
        }

        async function handleBooking() {
            const data = { 
                tanggal: document.getElementById('bk_tgl').value, 
                pekerjaan: document.getElementById('bk_job').value, 
                email: customerData.email, lat: customerData.lat, lng: customerData.lng 
            };
            await callAPI('saveBooking', data);
            Swal.fire('Berhasil', 'Pesanan dikirim.', 'success').then(()=>location.reload());
        }

        function initMap(cid) {
            const m = document.getElementById('map');
            document.getElementById(cid).appendChild(m);
            if (!map) {
                map = L.map('map', {zoomControl:false}).setView([-8.1925, 114.3820], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
            setTimeout(()=>map.invalidateSize(), 200);
        }

        function getLocation() {
            navigator.geolocation.getCurrentPosition(p => {
                selectedPos = { lat: p.coords.latitude, lng: p.coords.longitude };
                map.setView([selectedPos.lat, selectedPos.lng], 16);
                if (marker) map.removeLayer(marker);
                marker = L.marker([selectedPos.lat, selectedPos.lng], {draggable:true}).addTo(map);
                document.getElementById('action-buttons').classList.remove('hidden');
            });
        }

        function handleLogout() { localStorage.removeItem('nanda_teknik_user'); location.reload(); }
    </script>
</body>
</html>
