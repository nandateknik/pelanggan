<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nanda Teknik - Client App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f8fafc; }
    #map { height: 250px; border-radius: 1rem; width: 100%; }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 2rem; border: 1px solid white; }
  </style>
</head>
<body class="p-4" onload="checkAutoLogin()">
  <div class="max-w-md mx-auto space-y-4">
    <header class="text-center py-4">
      <h1 class="text-3xl font-black text-blue-600 italic tracking-tighter uppercase">NANDA TEKNIK</h1>
      <div id="user-badge" class="hidden text-[10px] font-bold text-slate-500 bg-white inline-block px-3 py-1 rounded-full shadow-sm mt-2 border"></div>
    </header>

    <div id="main-card" class="glass p-6 shadow-xl">
      <div id="dynamic-area">
        <div class="text-center py-10 animate-pulse text-slate-400 font-bold">MENGHUBUNGKAN...</div>
      </div>

      <div id="footer-menu" class="mt-6 pt-4 border-t flex justify-between items-center px-2">
         <button onclick="formHistory()" class="text-[9px] font-black text-slate-400 uppercase">Riwayat & Nota</button>
         <button id="btn-logout" onclick="handleLogout()" class="hidden text-[9px] font-black text-red-500 uppercase">Logout</button>
      </div>
    </div>
  </div>

  <div id="map-storage" class="hidden"><div id="map"></div></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // --- MASUKKAN URL EXEC ANDA DI SINI ---
  const API_URL = "https://script.google.com/macros/s/AKfycbzKtjXT9y0INCh0CPkgo9kzEkq2oSZy7nwRU6tf7J_WNVD70O_PNEbqQs4JvHQNYcXNcg/exec"; 

  let map, marker, selectedPos, customerData;

  async function callAPI(action, data = {}) {
    const params = new URLSearchParams({ action, ...data });
    try {
      // Menggunakan fetch standar dengan pengalihan otomatis
      const response = await fetch(`${API_URL}?${params.toString()}`);
      return await response.json();
    } catch (err) {
      console.error(err);
      Swal.fire("API Error", "Pastikan Deployment Web App sudah 'Anyone'.", "error");
    }
  }

  function initMap() {
    if (!map) {
      map = L.map('map', { zoomControl: false }).setView([-8.1925, 114.3820], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    }
  }

  function checkAutoLogin() {
    initMap();
    const saved = localStorage.getItem('nanda_teknik_user');
    if (saved && saved !== "undefined") {
      customerData = JSON.parse(saved);
      showBookingForm();
    } else {
      showLandingPage();
    }
  }

  function showLandingPage() {
    const mapEl = document.getElementById('map');
    document.getElementById('dynamic-area').innerHTML = `
      <h3 class="font-bold text-slate-700 mb-2 italic">üìç Lokasi Servis</h3>
      <div id="map-container" class="rounded-2xl overflow-hidden bg-slate-100 border"></div>
      <button onclick="getLocation()" class="w-full mt-4 bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg">üìç Cari Lokasi Saya</button>
      <div id="action-buttons" class="hidden mt-6 grid grid-cols-2 gap-4">
         <button onclick="formLogin()" class="bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-md">Masuk</button>
         <button onclick="formDaftar()" class="bg-slate-800 text-white py-4 rounded-2xl font-bold">Daftar</button>
      </div>`;
    document.getElementById('map-container').appendChild(mapEl);
    setTimeout(() => map.invalidateSize(), 200);
  }

  function formDaftar() {
    document.getElementById('dynamic-area').innerHTML = `
      <div class="space-y-3">
        <h3 class="font-black text-blue-600 uppercase">Pendaftaran</h3>
        <input id="reg_nama" type="text" placeholder="Nama Lengkap" class="w-full p-4 border rounded-xl text-sm">
        <input id="reg_email" type="email" placeholder="Email Aktif" class="w-full p-4 border rounded-xl text-sm">
        <input id="reg_wa" type="number" placeholder="WhatsApp" class="w-full p-4 border rounded-xl text-sm">
        <button onclick="handleRegister()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">Daftar Sekarang</button>
        <button onclick="showLandingPage()" class="w-full text-slate-400 py-2 text-[10px] font-bold">KEMBALI</button>
      </div>`;
  }

  async function handleRegister() {
    const data = {
      nama: document.getElementById('reg_nama').value,
      email: document.getElementById('reg_email').value,
      whatsapp: document.getElementById('reg_wa').value,
      lat: selectedPos?.lat,
      lng: selectedPos?.lng
    };
    if (!data.nama || !data.email || !data.lat) return Swal.fire("Lengkapi Lokasi & Data", "", "warning");
    
    Swal.fire({ title: 'Proses...', didOpen: () => Swal.showLoading() });
    const res = await callAPI('registerCustomer', data);
    Swal.fire('Berhasil', res, 'success').then(() => showLandingPage());
  }

  async function formLogin() {
    const { value: email } = await Swal.fire({ title: 'Login', input: 'email', inputPlaceholder: 'Email Anda' });
    if (email) {
      Swal.fire({ title: 'Mengecek...', didOpen: () => Swal.showLoading() });
      const res = await callAPI('checkCustomer', { email });
      if (res && res.exists) {
        customerData = res.data;
        localStorage.setItem('nanda_teknik_user', JSON.stringify(res.data));
        location.reload();
      } else {
        Swal.fire('Gagal', 'Email tidak terdaftar.', 'error');
      }
    }
  }

  function showBookingForm() {
    document.getElementById('user-badge').innerText = `HALO, ${customerData.nama}`;
    document.getElementById('user-badge').classList.remove('hidden');
    document.getElementById('btn-logout').classList.remove('hidden');
    document.getElementById('dynamic-area').innerHTML = `
      <div class="space-y-4">
        <h3 class="font-black text-blue-600 uppercase">Order Baru</h3>
        <input id="bk_tgl" type="date" class="w-full p-4 border rounded-xl text-sm">
        <input id="bk_job" type="text" placeholder="Pekerjaan (Contoh: Cuci AC)" class="w-full p-4 border rounded-xl text-sm">
        <button onclick="handleBooking()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase">Kirim Pesanan</button>
      </div>`;
  }

  async function handleBooking() {
    const job = document.getElementById('bk_job').value;
    const tgl = document.getElementById('bk_tgl').value;
    if(!job || !tgl) return Swal.fire('Isi Data', '', 'warning');
    Swal.fire({ title: 'Mengirim...', didOpen: () => Swal.showLoading() });
    await callAPI('saveBooking', { tanggal: tgl, pekerjaan: job, email: customerData.email, lat: customerData.lat, lng: customerData.lng });
    Swal.fire('Berhasil', 'Pesanan diterima.', 'success').then(() => location.reload());
  }

  function getLocation() {
    navigator.geolocation.getCurrentPosition((pos) => {
      selectedPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      initMap();
      map.setView([selectedPos.lat, selectedPos.lng], 17);
      if (marker) map.removeLayer(marker);
      marker = L.marker([selectedPos.lat, selectedPos.lng], {draggable: true}).addTo(map);
      document.getElementById('action-buttons').classList.remove('hidden');
    }, () => {
      Swal.fire("GPS Error", "Gunakan pin manual.", "warning");
      document.getElementById('action-buttons').classList.remove('hidden');
    });
  }

  function handleLogout() {
    localStorage.removeItem('nanda_teknik_user');
    location.reload();
  }
</script>
</body>
</html>
